<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://widget.cloudinary.com/v2.0/global/all.js" type="text/javascript"></script>
  <title>QR-Stream - Quick Recording</title>

  <!-- PWA (kept) -->
  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="/icons/icon.png">
  <!-- <meta name="theme-color" content="#000000"> -->

  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      text-align: center;
      margin: 0;
    }
    .container { max-width: 400px; margin: 0 auto; }
    video { width: 100%; max-width: 300px; height: 200px; background: black; border-radius: 10px; margin: 20px 0; }
    .link-area { background: white; color: black; padding: 20px; border-radius: 10px; margin: 20px 0; min-height: 150px; }
    button { padding: 15px 30px; margin: 10px; border: none; border-radius: 25px; font-size: 16px; font-weight: bold; cursor: pointer; }
    .btn-record { background: #4CAF50; color: white; }
    .btn-link { background: #2196F3; color: white; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    #status { margin: 15px 0; font-weight: bold; }
    .share-link { background: #f0f0f0; padding: 15px; border-radius: 8px; margin: 15px 0; border: 2px solid #2196F3; }
    .share-link input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ¥ QR-Stream</h1>
    <p>Quick Recording & Instant Sharing</p>

    <video id="video" autoplay muted playsinline></video>
    <div id="status">Starting camera...</div>

    <div class="link-area">
      <h3>ğŸ”— Shareable Link</h3>
      <div id="linkArea">
        <p style="color: #666; padding: 40px;">Record something first, then generate your shareable link</p>
      </div>
    </div>

    <button class="btn-record" id="recordBtn" disabled>ğŸ”´ Start Recording</button>
    <button class="btn-link" id="linkBtn" disabled>ğŸ”— Generate Link</button>
  </div>

  <script>
    // ===== Cloudinary config =====
    const CLOUDINARY_CLOUD_NAME = 'dlsnu3frt';
    const CLOUDINARY_UPLOAD_PRESET = 'qr_stream_preset';

    // ===== App state =====
    let recording = false;
    let hasRecording = false;
    let recordedBlob = null;      // now real data will be stored here
    let mediaRecorder = null;
    let chunks = [];
    let currentStream = null;

    const video = document.getElementById('video');
    const recordBtn = document.getElementById('recordBtn');
    const linkBtn = document.getElementById('linkBtn');
    const status = document.getElementById('status');
    const linkArea = document.getElementById('linkArea');

    // ===== Start camera =====
    async function startCamera() {
      try {
        currentStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        video.srcObject = currentStream;
        status.textContent = "ğŸ“¹ Camera ready! Tap to start recording";
        recordBtn.disabled = false;
      } catch (err) {
        status.textContent = "âŒ Camera error: " + err.message;
      }
    }
    startCamera();

    // ===== Pick a supported mime type (helps Safari/Chrome) =====
    function pickMimeType() {
      const types = [
        'video/webm;codecs=vp9',
        'video/webm;codecs=vp8',
        'video/webm',
      ];
      for (const t of types) {
        if (window.MediaRecorder && MediaRecorder.isTypeSupported && MediaRecorder.isTypeSupported(t)) {
          return t;
        }
      }
      return undefined; // let browser choose
    }

    // ===== Record button =====
    recordBtn.addEventListener('click', () => {
      if (!recording) {
        if (!currentStream) {
          status.textContent = "âŒ No camera stream.";
          return;
        }
        chunks = [];
        const mimeType = pickMimeType();
        try {
          mediaRecorder = new MediaRecorder(currentStream, mimeType ? { mimeType } : undefined);
        } catch (e) {
          status.textContent = "âŒ Recording not supported on this browser/device.";
          return;
        }

        mediaRecorder.ondataavailable = (e) => {
          if (e.data && e.data.size > 0) chunks.push(e.data);
        };
        mediaRecorder.onstop = () => {
          recordedBlob = new Blob(chunks, { type: mimeType || 'video/webm' });
          hasRecording = true;
          linkBtn.disabled = false;
          status.textContent = 'âœ… Recording complete! Generate shareable link';
        };

        mediaRecorder.start(); // start recording
        recording = true;
        recordBtn.textContent = 'â¹ï¸ Stop Recording';
        recordBtn.style.background = '#f44336';
        status.textContent = 'ğŸ”´ Recording... (tap stop when done)';
      } else {
        // stop recording
        recording = false;
        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
          mediaRecorder.stop();
        }
        recordBtn.textContent = 'ğŸ”´ Start Recording';
        recordBtn.style.background = '#4CAF50';
      }
    });

    // ===== Generate link (upload real blob to Cloudinary) =====
    linkBtn.addEventListener('click', async () => {
      if (!hasRecording || !recordedBlob) {
        status.textContent = 'âš ï¸ Please record something first.';
        return;
      }

      status.textContent = 'â³ Uploading your recording to cloud...';
      try {
        const eventName = prompt("What event is this from? (e.g., 'Sarah\\'s Wedding', 'Birthday Party')") || "Special Event";
        const uploadResult = await uploadToCloudinary(recordedBlob);

        if (uploadResult.secure_url) {
          const recordingTime = new Date().toLocaleString();
          const shareMessage = `ğŸ¥ Check out this moment from ${eventName}!

ğŸ“… Recorded: ${recordingTime}
ğŸ“± Created with: QR-Stream App
ğŸ¬ Watch here: ${uploadResult.secure_url}

#QRStream #${eventName.replace(/\s+/g, '')}`;

          linkArea.innerHTML = `
            <h4>ğŸ¬ Your Recording is Ready!</h4>
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0;">
              <strong>Event:</strong> ${eventName}<br>
              <strong>Time:</strong> ${recordingTime}<br>
              <strong>Link:</strong> <a href="${uploadResult.secure_url}" target="_blank" style="color: #2196F3;">View Recording</a>
            </div>
            <div class="share-message" style="background: white; border: 2px solid #2196F3; border-radius: 8px; padding: 15px; margin: 15px 0;">
              <textarea readonly onclick="copyMessage(this)" style="width: 100%; height: 120px; border: none; font-size: 14px; resize: none; background: transparent;">${shareMessage}</textarea>
            </div>
            <div style="margin: 15px 0;">
              <button onclick="shareWhatsApp('${shareMessage.replace(/'/g, "\\'")}');" style="padding: 12px 25px; background: #25D366; color: white; border: none; border-radius: 25px; font-size: 16px; font-weight: bold; margin: 5px;">ğŸ“± Share on WhatsApp</button>
              <button onclick="copyMessage(document.querySelector('.share-message textarea'))" style="padding: 12px 25px; background: #2196F3; color: white; border: none; border-radius: 25px; font-size: 16px; font-weight: bold; margin: 5px;">ğŸ“‹ Copy Message</button>
              <button onclick="window.open('${uploadResult.secure_url}', '_blank')" style="padding: 12px 25px; background: #FF5722; color: white; border: none; border-radius: 25px; font-size: 16px; font-weight: bold; margin: 5px;">ğŸ¬ Preview Video</button>
            </div>
            <p style="font-size: 12px; color: #666; margin-top: 15px;">ğŸ‘† Your recording is now online! Share the real video link anywhere!</p>
          `;
          status.textContent = 'âœ… Recording uploaded! Share your real video link anywhere!';
        }
      } catch (error) {
        console.error('Upload failed:', error);
        status.textContent = 'âŒ Upload failed. Please try again.';
      }
    });

    // ===== Cloudinary upload =====
    async function uploadToCloudinary(blob) {
      const formData = new FormData();
      formData.append('file', blob);
      formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);

      // Use the video endpoint since we're uploading a recording
      const url = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/video/upload`;
      const response = await fetch(url, { method: 'POST', body: formData });
      if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
      return await response.json();
    }

    // ===== Helpers =====
    function copyMessage(textarea) {
      textarea.select();
      document.execCommand('copy');
      alert('âœ… Message copied! Now you can paste it anywhere - WhatsApp, Instagram, Facebook, Email!');
    }
    function shareWhatsApp(message) {
      const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
      window.open(whatsappUrl, '_blank');
    }
  </script>

  <!-- PWA: service worker registration -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js');
    }
  </script>
</body>
</html>
                                                                                
  
  
  
  
                    
                      
  
