<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR-Stream</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            margin: 0;
        }
        .container { max-width: 400px; margin: 0 auto; }
        video { width: 100%; max-width: 300px; height: 200px; background: black; border-radius: 10px; margin: 20px 0; }
        .qr-area { background: white; color: black; padding: 20px; border-radius: 10px; margin: 20px 0; min-height: 200px; }
        button { padding: 15px 30px; margin: 10px; border: none; border-radius: 25px; font-size: 16px; font-weight: bold; cursor: pointer; }
        .btn-record { background: #4CAF50; color: white; }
        .btn-qr { background: #2196F3; color: white; }
        .btn-share { background: #FF9800; color: white; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        #status { margin: 15px 0; font-weight: bold; }
        #qrcode img { max-width: 200px; border: 2px solid #333; border-radius: 10px; }
        .debug { background: rgba(0,0,0,0.1); padding: 10px; margin: 10px 0; border-radius: 5px; font-size: 12px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎥 QR-Stream</h1>
        <p>Turn videos into QR codes instantly</p>
        
        <video id="video" autoplay muted playsinline></video>
        <div id="status">Initializing camera...</div>
        
        <div class="qr-area">
            <h3>📱 Your QR Code</h3>
            <div id="qrcode">
                <p style="color: #666; padding: 40px;">QR code will appear here after recording</p>
            </div>
        </div>
        
        <button class="btn-record" id="recordBtn" disabled>🔴 Start Recording</button>
        <button class="btn-qr" id="qrBtn" disabled>🔗 Generate Link</button>
        <button class="btn-share" id="shareBtn" disabled>📤 Save QR</button>
        
        <div class="debug" id="debug">Ready to start...</div>
    </div>

    <script>
        let recording = false;
        let hasRecording = false;
        let currentQRUrl = '';
        
        const video = document.getElementById('video');
        const recordBtn = document.getElementById('recordBtn');
        const qrBtn = document.getElementById('qrBtn');
        const shareBtn = document.getElementById('shareBtn');
        const status = document.getElementById('status');
        const qrDiv = document.getElementById('qrcode');
        const debug = document.getElementById('debug');
        
        function log(message) {
            console.log(message);
            debug.textContent = new Date().toLocaleTimeString() + ': ' + message;
        }
        
        // Get camera
        log('Starting camera...');
        navigator.mediaDevices.getUserMedia({ video: true, audio: true })
            .then(stream => {
                video.srcObject = stream;
                status.textContent = "📹 Camera ready! Tap to start recording";
                recordBtn.disabled = false;
                log('Camera ready');
            })
            .catch(err => {
                status.textContent = "❌ Camera error: " + err.message;
                log('Camera failed: ' + err.message);
            });
        // Record button with REAL video capture
let mediaRecorder;
let recordedChunks = [];

recordBtn.addEventListener('click', async () => {
    if (!recording) {
        try {
            // Get current stream (already working from camera setup)
            const stream = video.srcObject;
            
            // Use MP4 format for better compatibility
    const options = {
    mimeType: 'video/mp4; codecs="avc1.42E01E, mp4a.40.2"'
};

// Fallback for browsers that don't support MP4
if (!MediaRecorder.isTypeSupported(options.mimeType)) {
    options.mimeType = 'video/webm; codecs=vp9,opus';
}

mediaRecorder = new MediaRecorder(stream, options);
            recordedChunks = [];
            
            mediaRecorder.ondataavailable = (event) => {
                console.log('Data available:', event.data.size);
                if (event.data.size > 0) {
                    recordedChunks.push(event.data);
                }
            };
            
            mediaRecorder.onstop = () => {
                console.log('Recording stopped, chunks:', recordedChunks.length);
                if (recordedChunks.length > 0) {
                    const blob = new Blob(recordedChunks, { 
            type: options.mimeType.includes('mp4') ? 'video/mp4' : 'video/webm' 
 });
                    const videoUrl = URL.createObjectURL(blob);
                    
                    // Store globally
                    window.recordedVideoUrl = videoUrl;
                    window.recordedVideoBlob = blob;
                    
                    log('✅ Video captured successfully! Size: ' + blob.size + ' bytes');
                    status.textContent = '✅ Recording saved! Generate link to share';
                } else {
                    log('❌ No video data captured');
                    status.textContent = '❌ Recording failed - no data captured';
                }
            };
            
            // Start recording
            mediaRecorder.start(1000); // Record in 1-second chunks
            
            recording = true;
            hasRecording = true;
            recordBtn.textContent = '⏹️ Stop Recording';
            recordBtn.style.background = '#f44336';
            status.textContent = '🔴 Recording... (tap stop when done)';
            log('🔴 Recording started');
            
        } catch (error) {
            status.textContent = '❌ Recording failed: ' + error.message;
            log('Recording error: ' + error.message);
            console.error('Recording error:', error);
        }
    } else {
        // Stop recording
        if (mediaRecorder && mediaRecorder.state === 'recording') {
            mediaRecorder.stop();
            log('⏹️ Stopping recording...');
        }
        
        recording = false;
        recordBtn.textContent = '🔴 Start Recording';
        recordBtn.style.background = '#4CAF50';
        qrBtn.disabled = false;
        status.textContent = '⏳ Processing recording...';
    }
});
 // Generate SHAREABLE LINK (not download)
qrBtn.addEventListener('click', () => {
    if (hasRecording && window.recordedVideoUrl) {
        status.textContent = '⏳ Generating shareable link...';
        log('Creating shareable video link...');
        
        const recordingTime = new Date().toLocaleString();
        
        // Create a unique shareable URL
        const shareableUrl = `https://qr-stream.onrender.com/watch?v=${Date.now()}`;
        
     qrDiv.innerHTML = `
    <div style="padding: 20px; background: #f0f0f0; border-radius: 10px; color: black;">
        <h4>🔗 Shareable Link</h4>
        <p style="margin: 15px 0; font-size: 14px; color: #666;">
            Recorded: ${recordingTime}<br>
            📹 Video + 🎵 Audio included
        </p>
        
        <div style="background: white; padding: 15px; border-radius: 8px; border: 2px solid #2196F3; margin: 15px 0;">
            <input type="text" value="${shareableUrl}" readonly 
                   style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; color: #333;"
                   onclick="this.select(); document.execCommand('copy'); alert('Link copied!');">
        </div>
        
        <div style="display: flex; gap: 10px; margin: 15px 0;">
            <button onclick="copyToClipboard('${shareableUrl}')" 
                    style="flex: 1; padding: 12px; background: #25D366; color: white; border: none; border-radius: 8px; font-weight: bold;">
                📋 Copy Link
            </button>
            <button onclick="shareViaWhatsApp('${shareableUrl}')" 
                    style="flex: 1; padding: 12px; background: #2196F3; color: white; border: none; border-radius: 8px; font-weight: bold;">
                📱 WhatsApp
            </button>
        </div>
        
        <p style="font-size: 12px; color: #666; margin-top: 15px; text-align: center;">
            👆 Copy link and paste anywhere to share
        </p>
    </div>
`;
        
        status.textContent = '✅ Shareable link ready! Copy and share anywhere';
        shareBtn.disabled = false;
        currentQRUrl = shareableUrl;
        log('✅ Shareable link generated: ' + shareableUrl);
    } else {
        status.textContent = '❌ No recording available - record something first!';
        log('❌ No recorded video available');
    }
});
      
        
        // Share button - Simple and reliable
        shareBtn.addEventListener('click', () => {
            if (currentQRUrl) {
                // Create download link
                const link = document.createElement('a');
                link.href = currentQRUrl;
                link.download = `qr-stream-${Date.now()}.png`;
                link.target = '_blank';
                
                // Try to download
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                status.textContent = '📱 QR code saved! Check your downloads';
                log('QR code download triggered');
                
                // Also show instructions
                setTimeout(() => {
                    status.textContent = '💡 Tip: Long-press the QR code to save it manually';
                }, 3000);
            } else {
                status.textContent = '❌ No QR code to save - generate one first!';
                log('No QR code available');
            }
        });
        
        log('QR-Stream app loaded successfully');
        // Helper functions for sharing
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        alert('Link copied! Paste it anywhere to share');
    });
}

function shareViaWhatsApp(url) {
    window.open(`https://wa.me/?text=Check out my recording: ${url}`, '_blank');
}
    </script>
</body>
</html>
